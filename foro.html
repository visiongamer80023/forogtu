<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foro Demo - Completo</title>
    <style>
        /* --- Estilos Generales y Responsive --- */
        body {
            font-family: Arial, sans-serif;
            background-color: #DAE0E6; 
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 80%;
            max-width: 900px;
            margin: 20px auto;
            display: flex;
            gap: 20px;
        }

        .main-content {
            flex-grow: 1;
            background-color: #FFFFFF;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .sidebar {
            width: 300px;
            background-color: #FFFFFF;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
            display: flex;
            flex-direction: column; 
            gap: 20px;
        }
        
        /* --- Estilos de Navegaci√≥n de la Sidebar --- */
        .sidebar-section {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        
        .sidebar-section h3 {
            margin-top: 0;
            color: #FF4500;
            border-bottom: 1px solid #FF4500;
            padding-bottom: 5px;
        }

        .sidebar-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-section li {
            margin-bottom: 5px;
        }

        .sidebar-section a {
            text-decoration: none;
            color: #0079D3;
            font-weight: bold;
            display: block;
            padding: 5px;
            border-radius: 4px;
        }

        .sidebar-section a:hover {
            background-color: #E6F0F8;
        }

        .sidebar-section .active-theme {
            background-color: #0079D3;
            color: white;
        }

        /* --- Estilos de Autenticaci√≥n --- */
        #authScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #DAE0E6;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .auth-box {
            background-color: #FFFFFF;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 300px;
        }
        
        .header {
            background-color: #FFFFFF;
            padding: 10px 20px;
            border-bottom: 1px solid #ccc;
            display: flex;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
            transition: transform 0.3s ease-out, background-color 0.3s ease;
        }

        .header h1 {
            font-size: 24px;
            color: #FF4500;
            margin: 0;
            margin-right: 20px;
        }

        .auth-box h2 {
            color: #FF4500;
            margin-bottom: 20px;
        }
        .auth-box input[type="text"],
        .auth-box input[type="password"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .auth-box button {
            background-color: #0079D3;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-top: 5px;
        }
        .auth-box .toggle-link,
        .auth-box .forgot-link {
            display: block;
            margin-top: 15px;
            color: #0079D3;
            cursor: pointer;
            font-size: 14px;
        }
        #authMessage {
            margin-top: 10px;
            font-weight: bold;
            display: none;
            padding: 10px;
            border-radius: 4px;
        }
        #authMessage.error {
            color: #D32F2F;
            background-color: #FFCDD2;
        }
        #authMessage.success {
            color: #388E3C;
            background-color: #C8E6C9;
        }
        #registerFields, #recoveryFields, #resetFields {
            display: none; 
        }

        /* --- Estilos del Chatbot --- */
        #chatButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #FF4500;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 999;
            display: none;
            transition: transform 0.2s ease;
        }

        #chatButton:hover {
            transform: scale(1.05);
        }

        #chatWindow {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 300px;
            height: 400px;
            background-color: #FFFFFF;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 998;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background-color: #0079D3;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            cursor: move;
        }

        #chatMessages {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            background-color: #F7F7F7;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .user-message {
            background-color: #D3E0FF;
            align-self: flex-end;
            margin-left: auto;
            text-align: right;
        }

        .bot-message {
            background-color: #E6E6E6;
            align-self: flex-start;
        }

        .chat-input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ccc;
        }

        #chatInput {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 5px;
        }

        #sendChatButton {
            background-color: #0079D3;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* --- ESTILOS DE LA ANIMACI√ìN (KONAMI CODE) --- */
        @keyframes rainbow {
            0% { border-color: red; box-shadow: 0 0 15px red; }
            14% { border-color: orange; box-shadow: 0 0 15px orange; }
            28% { border-color: yellow; box-shadow: 0 0 15px yellow; }
            42% { border-color: green; box-shadow: 0 0 15px green; }
            56% { border-color: blue; box-shadow: 0 0 15px blue; }
            70% { border-color: indigo; box-shadow: 0 0 15px indigo; }
            84% { border-color: violet; box-shadow: 0 0 15px violet; }
            100% { border-color: red; box-shadow: 0 0 15px red; }
        }

        .konami-animation {
            animation: rainbow 1.5s infinite alternate;
            border-width: 3px;
            border-style: solid;
        }

        .header.konami-active {
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            25% { transform: translate(-1px, -2px) rotate(-1deg); }
            50% { transform: translate(-3px, 0px) rotate(1deg); }
            75% { transform: translate(1px, -2px) rotate(-1deg); }
            100% { transform: translate(1px, 1px) rotate(0deg); }
        }

        /* --- Media Queries --- */
        @media (max-width: 768px) {
            .container {
                width: 95%; 
                flex-direction: column;
                gap: 15px;
            }

            .sidebar {
                width: 100%;
                max-height: none; 
                order: 2; 
            }
            
            .main-content {
                order: 1;
            }

            .auth-box {
                width: 90%;
                margin: 0 10px;
            }

            #chatWindow {
                width: 90%;
                height: 80%;
                right: 5%;
                bottom: 90px;
            }
            
            #chatButton {
                right: 10px;
                bottom: 10px;
            }
        }
        
        /* Animaci√≥n de Escritura */
        @keyframes blink {
            50% { opacity: 0; }
        }
        .typing-indicator {
            display: inline-block;
            margin-left: 5px;
            font-weight: bold;
            font-size: 1.2em;
            letter-spacing: 2px;
            color: #0079D3;
        }
        .typing-indicator span {
            animation: blink 1s infinite;
        }
        .typing-indicator .dot1 { animation-delay: 0s; }
        .typing-indicator .dot2 { animation-delay: 0.2s; }
        .typing-indicator .dot3 { animation-delay: 0.4s; }
    </style>
</head>
<body>

    <div id="authScreen">
        <div class="auth-box">
            <h2 id="authTitle">üîê Iniciar Sesi√≥n</h2>
            
            <input type="text" id="usernameInput" placeholder="Usuario (ID)" required>
            <input type="password" id="passwordInput" placeholder="Contrase√±a" required>

            <div id="registerFields">
                <input type="password" id="confirmPasswordInput" placeholder="Confirmar Contrase√±a" required>
            </div>
            
            <div id="recoveryFields">
                <p>Ingresa tu ID de usuario para solicitar el c√≥digo.</p>
            </div>

            <div id="resetFields">
                <input type="text" id="codeInput" placeholder="C√≥digo de 6 d√≠gitos" required>
                <input type="password" id="newPasswordInput" placeholder="Nueva Contrase√±a" required>
            </div>
            
            <p id="authMessage"></p>

            <button id="authButton" onclick="handleAuth()">Ingresar</button>
            
            <a class="toggle-link" id="toggleLink" onclick="toggleAuthMode('register')">¬øNo tienes cuenta? Reg√≠strate aqu√≠.</a>
            <a class="forgot-link" id="forgotLink" onclick="toggleAuthMode('recover')">¬øOlvidaste tu contrase√±a?</a>
        </div>
    </div>

    <div id="forumContent" style="display:none;">
        <div class="header">
            <h1 id="forumTitle">r/Simulacion</h1>
            <p id="forumDescription">Temas de prueba y bienvenida.</p>
        </div>

        <div class="container">
            <div class="main-content">
                <h2>Crear un nuevo Post en <span id="currentThemeTitle">r/Simulacion</span></h2>
                <div class="post-form">
                    <textarea id="postInput" placeholder="Escribe tu mensaje o hazle una pregunta a la IA..." rows="4"></textarea>
                    <button onclick="submitPost()">Publicar</button>
                </div>

                <hr>

                <h2>Posts Recientes</h2>
                <div id="postsContainer">
                </div>
            </div>

            <div class="sidebar">
                <div class="sidebar-section">
                    <h3>Subreddits</h3>
                    <ul id="themeList">
                        </ul>
                </div>
                
                <div class="sidebar-section">
                    <h3>ü§ñ Mini-IA de Prueba</h3>
                    <p>Preguntas generales y tem√°ticas.</p>
                </div>
            </div>
        </div>
    </div>

    <button id="chatButton" onclick="toggleChatWindow()">üó®Ô∏è</button>

    <div id="chatWindow">
        <div class="chat-header" onmousedown="startDrag(event)">Ayuda y Soporte</div>
        <div id="chatMessages">
            <div class="message bot-message">¬°Hola! Soy tu asistente. Preg√∫ntame sobre **Login**, **Registro** o **Contrase√±a**.</div>
        </div>
        <div class="chat-input-container">
            <input type="text" id="chatInput" placeholder="Escribe tu duda..." onkeydown="handleChatInput(event)">
            <button id="sendChatButton" onclick="sendChatMessage()">‚û§</button>
        </div>
    </div>

    <script>
        // --- CONSTANTES Y ESTADO ---
        const STORAGE_KEY_USERS = 'forum_users';
        const STORAGE_KEY_POSTS = 'forum_posts';
        const TEMP_CODE_KEY = 'temp_recovery_code';
        const PREDEFINED_USER = "12345678";
        const PREDEFINED_PASS = "87654321";
        
        const THEMES = {
            'r/Simulacion': 'Temas de prueba y bienvenida.',
            'r/Gatos': 'Fotos y discusiones sobre felinos y mascotas.',
            'r/Tecnologia': 'Novedades, gadgets y software.',
            'r/Comida': 'Recetas, restaurantes y cr√≠ticas culinarias.',
        };
        let currentTheme = 'r/Simulacion';
        
        // Variable para controlar la ventana del virus simulado
        let idiotWindow = null; 

        // --- ALMACENAMIENTO DE DATOS ---
        function getStoredData(key, isUserStore, user, pass) {
            const stored = localStorage.getItem(key);
            if (stored) {
                return JSON.parse(stored);
            }
            if (isUserStore) {
                const initialUsers = {};
                initialUsers[user] = pass;
                return initialUsers;
            }
            return null;
        }

        let users = getStoredData(STORAGE_KEY_USERS, true, PREDEFINED_USER, PREDEFINED_PASS);
        let posts = getStoredData(STORAGE_KEY_POSTS, false, null) || [];

        function saveUsers() {
            localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(users));
        }
        
        function savePosts() {
            localStorage.setItem(STORAGE_KEY_POSTS, JSON.stringify(posts));
        }

        // --- ELEMENTOS DEL DOM ---
        const authScreen = document.getElementById('authScreen');
        const authTitle = document.getElementById('authTitle');
        const authButton = document.getElementById('authButton');
        const toggleLink = document.getElementById('toggleLink');
        const forgotLink = document.getElementById('forgotLink');
        const registerFields = document.getElementById('registerFields');
        const recoveryFields = document.getElementById('recoveryFields');
        const resetFields = document.getElementById('resetFields');
        const usernameInput = document.getElementById('usernameInput');
        const passwordInput = document.getElementById('passwordInput');
        const confirmPasswordInput = document.getElementById('confirmPasswordInput');
        const codeInput = document.getElementById('codeInput');
        const newPasswordInput = document.getElementById('newPasswordInput');
        const authMessage = document.getElementById('authMessage');
        const chatButton = document.getElementById('chatButton');
        const chatWindow = document.getElementById('chatWindow');
        const forumContent = document.getElementById('forumContent');
        const header = document.querySelector('.header');
        const forumTitle = document.getElementById('forumTitle');
        const forumDescription = document.getElementById('forumDescription');
        const currentThemeTitle = document.getElementById('currentThemeTitle');
        const themeList = document.getElementById('themeList');
        const postsContainer = document.getElementById('postsContainer');
        const postInput = document.getElementById('postInput');
        
        let currentMode = 'login'; 
        let currentRecoveryUser = null; 

        // --- L√ìGICA DE AUTENTICACI√ìN (Se mantiene igual) ---

        function cleanFormState() {
            usernameInput.value = '';
            passwordInput.value = '';
            confirmPasswordInput.value = '';
            codeInput.value = '';
            newPasswordInput.value = '';
            authMessage.style.display = 'none';
        }

        function toggleAuthMode(mode) {
            cleanFormState();
            currentMode = mode;
            currentRecoveryUser = null; 
            localStorage.removeItem(TEMP_CODE_KEY); 

            registerFields.style.display = 'none';
            recoveryFields.style.display = 'none';
            resetFields.style.display = 'none';
            toggleLink.style.display = 'block';
            forgotLink.style.display = 'block';
            usernameInput.style.display = 'block';

            if (mode === 'login') {
                authTitle.textContent = 'üîê Iniciar Sesi√≥n';
                authButton.textContent = 'Ingresar';
                passwordInput.style.display = 'block';
                toggleLink.textContent = '¬øNo tienes cuenta? Reg√≠strate aqu√≠.';
            } else if (mode === 'register') {
                authTitle.textContent = '‚úçÔ∏è Crear Cuenta';
                authButton.textContent = 'Registrarse';
                passwordInput.style.display = 'block';
                registerFields.style.display = 'block';
                toggleLink.textContent = '¬øYa tienes cuenta? Inicia Sesi√≥n.';
                forgotLink.style.display = 'none';
            } else if (mode === 'recover') {
                authTitle.textContent = '‚ùì Recuperar Contrase√±a';
                authButton.textContent = 'Solicitar C√≥digo';
                passwordInput.style.display = 'none';
                recoveryFields.style.display = 'block';
                toggleLink.style.display = 'none';
                forgotLink.textContent = 'Volver al Inicio de Sesi√≥n';
            } else if (mode === 'reset') {
                authTitle.textContent = 'üîÑ Restablecer Contrase√±a';
                authButton.textContent = 'Cambiar Contrase√±a';
                passwordInput.style.display = 'none';
                usernameInput.style.display = 'none';
                resetFields.style.display = 'block';
                toggleLink.style.display = 'none';
                forgotLink.textContent = 'Cancelar y Volver al Login';
            }
        }

        function showMessage(type, message) {
            authMessage.className = '';
            authMessage.classList.add(type);
            authMessage.innerHTML = message;
            authMessage.style.display = 'block';
        }
        
        function generateRecoveryCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        function initiateRecovery() {
            const user = usernameInput.value.trim();
            if (user === '') {
                showMessage('error', '‚ö†Ô∏è Por favor, ingresa tu ID de usuario.');
                return;
            }

            if (!users.hasOwnProperty(user)) {
                showMessage('error', '‚ö†Ô∏è Usuario no encontrado. Verifica tu ID.');
                return;
            }

            const code = generateRecoveryCode();
            localStorage.setItem(TEMP_CODE_KEY, code); 
            currentRecoveryUser = user;

            toggleAuthMode('reset');
            showMessage('success', `‚úÖ C√≥digo generado: **${code}**. Por favor, introd√∫celo abajo.`);
        }
        
        function completePasswordReset() {
            const code = codeInput.value.trim();
            const newPass = newPasswordInput.value;
            const storedCode = localStorage.getItem(TEMP_CODE_KEY);

            if (code !== storedCode) {
                showMessage('error', '‚ö†Ô∏è C√≥digo de verificaci√≥n incorrecto o expirado.');
                return;
            }

            if (newPass.length < 5) {
                showMessage('error', '‚ö†Ô∏è La nueva contrase√±a debe tener al menos 5 caracteres.');
                return;
            }

            users[currentRecoveryUser] = newPass;
            saveUsers();
            localStorage.removeItem(TEMP_CODE_KEY); 
            
            showMessage('success', `‚úÖ Contrase√±a restablecida para ${currentRecoveryUser}. Inicia sesi√≥n.`);
            toggleAuthMode('login'); 
        }

        function handleAuth() {
            if (currentMode === 'login') {
                const user = usernameInput.value.trim();
                const pass = passwordInput.value;

                if (users.hasOwnProperty(user)) {
                    if (users[user] === pass) {
                        authScreen.style.display = 'none';
                        forumContent.style.display = 'block';
                        chatButton.style.display = 'block';
                        
                        changeTheme(currentTheme); 
                        
                        createPostElement(`¬°Bienvenido, ${user}! Has accedido al foro ${currentTheme}.`, 'Admin', currentTheme, true);
                    } else {
                        showMessage('error', '‚ö†Ô∏è Contrase√±a incorrecta.');
                    }
                } else {
                    showMessage('error', '‚ö†Ô∏è Usuario no encontrado, favor de crear cuenta.');
                }
            } else if (currentMode === 'register') {
                const user = usernameInput.value.trim();
                const pass = passwordInput.value;
                const confirmPass = confirmPasswordInput.value;

                if (user === '' || pass === '') {
                    showMessage('error', '‚ö†Ô∏è Usuario y Contrase√±a son obligatorios.');
                    return;
                }
                if (pass !== confirmPass) {
                    showMessage('error', '‚ö†Ô∏è Las contrase√±as no coinciden.');
                    return;
                }
                if (users.hasOwnProperty(user)) {
                    showMessage('error', '‚ö†Ô∏è El usuario ya existe. Intenta iniciar sesi√≥n.');
                    return;
                }
                
                users[user] = pass;
                saveUsers();
                showMessage('success', `‚úÖ Usuario ${user} registrado. ¬°Inicia sesi√≥n!`);
                toggleAuthMode('login');
            } else if (currentMode === 'recover') {
                initiateRecovery();
            } else if (currentMode === 'reset') {
                completePasswordReset();
            }
        }
        
        function setupAuthListeners() {
            const fields = [usernameInput, passwordInput, confirmPasswordInput, codeInput, newPasswordInput];
            fields.forEach(input => {
                input.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        handleAuth();
                    }
                });
            });
            forgotLink.addEventListener('click', function(event) {
                event.preventDefault();
                if (currentMode === 'recover' || currentMode === 'reset') {
                    toggleAuthMode('login');
                }
            });
        }
        setupAuthListeners();

        // --- NAVEGACI√ìN DE TEMAS (Se mantiene igual) ---

        function renderThemeList() {
            themeList.innerHTML = '';
            for (const theme in THEMES) {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = '#';
                a.textContent = theme;
                a.onclick = (e) => {
                    e.preventDefault();
                    changeTheme(theme);
                };
                if (theme === currentTheme) {
                    a.classList.add('active-theme');
                }
                li.appendChild(a);
                themeList.appendChild(li);
            }
        }

        function changeTheme(newTheme) {
            currentTheme = newTheme;
            forumTitle.textContent = currentTheme;
            currentThemeTitle.textContent = currentTheme;
            forumDescription.textContent = THEMES[currentTheme];
            
            renderThemeList(); 
            renderPosts();
        }

        // --- L√ìGICA DEL FORO Y LA MINI-IA (TEM√ÅTICA, REDIRECCI√ìN Y EASTER EGGS) ---

        const aiName = 'Mini-IA ü§ñ';
        const userName = 'Usuario an√≥nimo'; 

        const generalAiResponses = {
            'que eres': 'Soy una Mini-IA de prueba programada en JavaScript para responder preguntas b√°sicas en este foro de demostraci√≥n.',
            'quien te creo': 'Fui creada por el desarrollador de esta p√°gina usando c√≥digo simple de JavaScript.',
            'como estas': 'Estoy bien, gracias por preguntar. Siempre lista para procesar informaci√≥n.',
            'hola': '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?',
            'adios': '¬°Hasta pronto! Espero verte de nuevo por aqu√≠.',
            'clima': 'No tengo acceso a datos en tiempo real, ¬°soy solo una IA de demostraci√≥n!',
            'hora': `La hora actual (simulada) es ${new Date().toLocaleTimeString()}.`,
            'color': 'Mi color favorito es el azul del c√≥digo.',
        };
        
        const themedAiResponses = {
            'r/Gatos': {
                'comen': 'Los gatos deben comer alimentos ricos en prote√≠nas, como carne y pescado, evitando el chocolate y la cebolla.',
                'duermen': 'Un gato adulto duerme en promedio entre 12 y 16 horas al d√≠a, ¬°son muy dormilones!',
                'juegan': 'Los juguetes con plumas y los punteros l√°ser (con moderaci√≥n) son excelentes para su ejercicio.',
                keywords: ['gato', 'felino', 'mascota', 'minino', 'comida para gatos', 'arenero'],
            },
            'r/Tecnologia': {
                'que es ia': 'La Inteligencia Artificial (IA) es la simulaci√≥n de procesos de inteligencia humana por m√°quinas, especialmente sistemas inform√°ticos.',
                'bitcoin': 'Bitcoin es una criptomoneda descentralizada, lo que significa que opera sin un banco central o administrador √∫nico.',
                'futuro': 'El futuro de la tecnolog√≠a incluye la computaci√≥n cu√°ntica, la IA avanzada y la integraci√≥n total de IoT (Internet de las Cosas).',
                keywords: ['ia', 'bitcoin', 'cripto', 'software', 'hardware', 'gadget', 'computadora', 'servidor', 'programa'],
            },
            'r/Comida': {
                'pasta': 'Una buena salsa bolo√±esa siempre lleva tomate, carne molida y un sofrito de cebolla y zanahoria.',
                'receta facil': 'Prueba un aguacate con sal, pimienta y aceite de oliva. ¬°R√°pido y delicioso!',
                'picante': 'El nivel de picante se mide en la escala Scoville, que cuantifica la concentraci√≥n de capsaicina.',
                keywords: ['receta', 'cocina', 'restaurante', 'ingrediente', 'sabor', 'comer', 'postre', 'platillo'],
            },
        };

        postInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey && !event.ctrlKey) {
                event.preventDefault(); 
                submitPost();
            }
        });
        
        // --- FUNCI√ìN DEL EASTER EGG LOVE BUG ---
        function handleLoveBugActivation() {
            alert("¬°ERROR! Ha activado un c√≥digo de demostraci√≥n.\n\nSimulando la aparici√≥n del 'Love Bug'.\n\n\n(No es un virus real, es un easter egg)");

            const aiResponse = "¬°ALERTA! Detecto una referencia a **ILOVEYOU.vbs**. Ese c√≥digo fue muy peligroso en su d√≠a. ¬°Cuidado con los archivos adjuntos inesperados!";
            
            // Post del bot inmediatamente
            const aiPost = { content: aiResponse, author: aiName, theme: currentTheme, timestamp: Date.now() };
            posts.unshift(aiPost);
            savePosts();
            createPostElement(aiResponse, aiName, currentTheme);
            
            // Efecto visual temporal
            header.style.backgroundColor = '#FF6666'; 
            header.style.color = 'white';

            setTimeout(() => {
                header.style.backgroundColor = '#FFFFFF';
                header.style.color = 'initial'; 
            }, 3000);
        }

        // --- FUNCI√ìN DEL EASTER EGG YOU ARE AN IDIOT (ACTUALIZADA con Cierre) ---
        function handleIdiotActivation() {
            // 1. Alerta de la supuesta infecci√≥n
            alert("¬°ERROR! Ha activado un c√≥digo de demostraci√≥n.\n\nSimulando la aparici√≥n del 'You Are An Idiot' (Troyano Offiz).\n\n\n(¬°Mecanismo de cierre disponible!)");

            // 2. Respuesta tem√°tica del bot
            const aiResponse = "¬°ALERTA! El Troyano **You Are An Idiot** ha sido activado. Para detenerlo y cerrar las ventanas, publica: **stop idiot** en un nuevo post. ¬°Date prisa!";
            
            // 3. Simulaci√≥n de la apertura de ventanas molestas
            for (let i = 0; i < 5; i++) {
                // Abrir una ventana peque√±a en blanco.
                window.open('about:blank', `window${Date.now() + i}`, 'width=300,height=200,resizable=no,scrollbars=no');
            }
            
            // 4. Generar el post del bot inmediatamente
            const aiPost = { content: aiResponse, author: aiName, theme: currentTheme, timestamp: Date.now() };
            posts.unshift(aiPost);
            savePosts();
            createPostElement(aiResponse, aiName, currentTheme);

            // 5. Efecto visual temporal
            header.style.backgroundColor = '#FF9900'; // Naranja/√Åmbar
            header.style.color = 'black';

            setTimeout(() => {
                header.style.backgroundColor = '#FFFFFF';
                header.style.color = 'initial'; 
            }, 3000); 
        }

        // --- FUNCI√ìN PARA DETENER EL VIRUS SIMULADO ---
        function handleIdiotStop() {
            const aiResponse = "‚úÖ **¬°T√©rmino del proceso forzado!** El troyano simulado se ha detenido. Las ventanas emergentes deber√≠an cerrarse y la amenaza en el encabezado ha desaparecido.";
            
            // 1. Cierra las ventanas que el c√≥digo de activaci√≥n abri√≥
            // (Esto depende de la pol√≠tica del navegador, pero es la simulaci√≥n)
            if (window) {
                // Intentar cerrar la ventana principal (solo funciona si JS la abri√≥)
                window.close(); 
            }
            
            // 2. Desactivar el efecto visual
            header.style.backgroundColor = '#C8E6C9'; 
            header.style.color = 'black';
            setTimeout(() => {
                header.style.backgroundColor = '#FFFFFF';
            }, 1000);

            // 3. Post de confirmaci√≥n
            const aiPost = { content: aiResponse, author: aiName, theme: currentTheme, timestamp: Date.now() };
            posts.unshift(aiPost);
            savePosts();
            createPostElement(aiResponse, aiName, currentTheme);

            // 4. Muestra una alerta de confirmaci√≥n
            alert("¬°SIMULACI√ìN DETENIDA! El comando 'stop idiot' ha sido ejecutado.");
        }
        // --------------------------------------------------------
        
        /**
         * Revisa si el post actual deber√≠a haber sido publicado en otro tema. (Se mantiene igual)
         */
        function checkThemeMisplacement(text) {
            const lowerText = text.toLowerCase();
            
            for (const theme in themedAiResponses) {
                if (theme === currentTheme) continue; 
                
                const keywords = themedAiResponses[theme].keywords;
                if (keywords) {
                    const matchCount = keywords.filter(keyword => lowerText.includes(keyword)).length;
                    
                    if (matchCount >= 2) {
                        return theme; 
                    }
                }
            }
            return null;
        }

        /**
         * Obtiene la respuesta de la IA (tem√°tica o general). (Se mantiene igual)
         */
        function checkAI(text) {
            const lowerText = text.toLowerCase();
            
            const themeAnswers = themedAiResponses[currentTheme];
            if (themeAnswers) {
                for (const keyword in themeAnswers) {
                    if (lowerText.includes(keyword) && keyword !== 'keywords') {
                        return themeAnswers[keyword];
                    }
                }
            }

            for (const keyword in generalAiResponses) {
                if (lowerText.includes(keyword)) {
                    return generalAiResponses[keyword];
                }
            }

            if (lowerText.startsWith('que ') || lowerText.startsWith('quien ') || lowerText.startsWith('como ') || lowerText.startsWith('cuando ')) {
                return `Esa es una buena pregunta, pero no tengo una respuesta espec√≠fica para **${currentTheme}** o no est√° en mi base de conocimiento.`;
            }
            return null;
        }

        function createPostElement(content, author, themeTag, isSystemMsg = false) {
            const postDiv = document.createElement('div');
            postDiv.classList.add('post');
            
            if (author === aiName || isSystemMsg) {
                postDiv.classList.add('ai-post');
            }

            const votesDiv = document.createElement('div');
            votesDiv.classList.add('votes');
            votesDiv.innerHTML = `
                <span class="vote-arrow">‚ñ≤</span>
                <span>0</span>
                <span class="vote-arrow">‚ñº</span>
            `;
            
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('post-content');
            
            const title = isSystemMsg ? `${themeTag}` : (author === aiName ? `Respuesta de ${aiName}` : `Nuevo post en ${themeTag}`);

            const formattedContent = content.replace(/(\*\*|__)/g, '<b>$1</b>'); 

            contentDiv.innerHTML = `
                <h3>${title}</h3>
                <p>${formattedContent}</p>
                <div class="post-meta">Publicado por ${author} hace un momento</div>
            `;

            postDiv.appendChild(votesDiv);
            postDiv.appendChild(contentDiv);

            if (document.body.classList.contains('konami-active')) {
                postDiv.classList.add('konami-animation');
            }
            
            postsContainer.prepend(postDiv);
            return postDiv; 
        }

        /**
         * Funci√≥n principal para publicar un post (ACTUALIZADA con doble Easter Egg check)
         */
        function submitPost() {
            const postText = postInput.value.trim();

            if (postText === '') {
                postInput.value = ''; 
                return;
            }
            
            let targetTheme = currentTheme;
            let isRedirected = false;
            let isEasterEgg = false;

            const lowerText = postText.toLowerCase();
            
            // 1. Detecci√≥n de Comando de Detenci√≥n
            if (lowerText.includes('stop idiot')) {
                handleIdiotStop();
                postInput.value = '';
                return; 
            }

            // 2. Detecci√≥n de Easter Eggs de Activaci√≥n
            if (lowerText.includes('you are an idiot') || lowerText.includes('youareanidiot')) {
                handleIdiotActivation();
                isEasterEgg = true;
            } else if (lowerText.includes('i love you') || lowerText.includes('iloveyou')) {
                handleLoveBugActivation();
                isEasterEgg = true;
            }

            // 3. Verificar si el post debe ser movido (Redirecci√≥n Tem√°tica)
            const suggestedTheme = checkThemeMisplacement(postText);

            if (!isEasterEgg && suggestedTheme && suggestedTheme !== currentTheme) {
                const redirectMessage = `‚ö†Ô∏è Este post parece ser sobre **${suggestedTheme}**. Ha sido movido autom√°ticamente. Por favor, navega a ese tema para verlo.`;
                createPostElement(redirectMessage, 'Sistema de Moderaci√≥n', currentTheme, true);
                
                targetTheme = suggestedTheme;
                isRedirected = true;
            }

            // 4. Guardar el post original
            const newPost = {
                content: postText,
                author: userName,
                theme: targetTheme, 
                timestamp: Date.now()
            };
            posts.unshift(newPost);
            savePosts();
            
            // 5. Renderizar o Redirigir la vista
            if (!isRedirected) {
                // Si NO fue redirigido, simplemente renderiza el post
                createPostElement(postText, userName, currentTheme);
            } else {
                // Si fue redirigido, cambiar inmediatamente al tema sugerido
                changeTheme(targetTheme); 
                const originalSnippet = postText.length > 50 ? postText.substring(0, 50) + '...' : postText;
                const finalMessage = `‚úÖ Mensaje de ${userName} movido desde el subreddit anterior a **${targetTheme}**: "${originalSnippet}"`;
                createPostElement(finalMessage, 'Sistema de Redirecci√≥n', targetTheme, true);
            }

            // 6. Verificar IA (solo si NO fue un Easter Egg)
            if (!isEasterEgg) {
                const aiResponse = checkAI(postText);
                if (aiResponse) {
                    handleAIResponse(aiResponse, targetTheme);
                }
            }

            postInput.value = '';
        }
        
        function handleAIResponse(response, postTheme) {
            const aiPost = {
                content: response,
                author: aiName,
                theme: postTheme, 
                timestamp: Date.now()
            };
            posts.unshift(aiPost);
            savePosts();
            
            if (postTheme === currentTheme) {
                const typingIndicatorPost = createPostElement('Escribiendo', aiName, postTheme);
                const contentParagraph = typingIndicatorPost.querySelector('.post-content p');
                
                contentParagraph.innerHTML = `
                    ${aiName} est√° escribiendo<span class="typing-indicator">
                        <span class="dot1">.</span>
                        <span class="dot2">.</span>
                        <span class="dot3">.</span>
                    </span>
                `;

                setTimeout(() => {
                    const postContentDiv = typingIndicatorPost.querySelector('.post-content');
                    postContentDiv.querySelector('p').innerHTML = response;
                }, 1500);
            }
        }

        function renderPosts() {
            postsContainer.innerHTML = '';
            
            const filteredPosts = posts.filter(post => post.theme === currentTheme);
            
            filteredPosts.forEach(post => {
                createPostElement(post.content, post.author, post.theme, post.author === 'Admin');
            });
        }
        
        // --- L√ìGICA DEL CHATBOT DE AYUDA (Se mantiene igual) ---

        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');

        const chatbotResponses = {
            'login': 'El **Login** es la pantalla inicial donde ingresas tu ID y Contrase√±a. Si es incorrecta, revisa si el usuario existe o si la clave es err√≥nea.',
            'registro': 'Para **Registrarte**, haz clic en "¬øNo tienes cuenta? Reg√≠strate aqu√≠." y crea un nuevo ID y contrase√±a.',
            'contrase√±a': 'Si olvidaste tu **Contrase√±a**, usa el enlace "¬øOlvidaste tu contrase√±a?" para solicitar un c√≥digo de restablecimiento.',
            'foro': 'El **Foro** es el lugar donde puedes publicar mensajes e interactuar con otros usuarios y la Mini-IA.',
            'ayuda': 'Estoy aqu√≠ para resolver dudas sobre el uso del foro y las cuentas (Login, Registro, Contrase√±a).',
            'hola': '¬°Hola! ¬øEn qu√© puedo ayudarte hoy? Preg√∫ntame sobre Login, Registro o Contrase√±a.',
        };

        function toggleChatWindow() {
            chatWindow.style.display = chatWindow.style.display === 'flex' ? 'none' : 'flex';
            chatInput.focus();
        }

        function handleChatInput(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function addMessage(text, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
            msgDiv.innerHTML = text; 
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendChatMessage() {
            const message = chatInput.value.trim();
            chatInput.value = '';
            if (message === '') return;

            addMessage(message, 'user');
            
            setTimeout(() => {
                getBotResponse(message);
            }, 500); 
        }

        function getBotResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            let response = chatbotResponses['ayuda'];

            for (const keyword in chatbotResponses) {
                if (lowerMessage.includes(keyword)) {
                    response = chatbotResponses[keyword];
                    break;
                }
            }
            
            addMessage(response, 'bot');
        }
        
        // --- Arrastrar la ventana del chat ---
        let isDragging = false;
        let offset = { x: 0, y: 0 };
        const chatHeader = document.querySelector('.chat-header');
        
        function startDrag(e) {
            isDragging = true;
            offset.x = e.clientX - chatWindow.offsetLeft;
            offset.y = e.clientY - chatWindow.offsetTop;
            document.addEventListener('mousemove', dragChatWindow);
            document.addEventListener('mouseup', stopDrag);
        }
        
        function dragChatWindow(e) {
            if (!isDragging) return;
            chatWindow.style.left = (e.clientX - offset.x) + 'px';
            chatWindow.style.top = (e.clientY - offset.y) + 'px';
            chatWindow.style.right = 'auto'; 
            chatWindow.style.bottom = 'auto';
        }

        function stopDrag() {
            isDragging = false;
            document.removeEventListener('mousemove', dragChatWindow);
            document.removeEventListener('mouseup', stopDrag);
        }
        
        // --- L√ìGICA DEL C√ìDIGO KONAMI (Se mantiene igual) ---

        const konamiCode = [
            'ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown',
            'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight',
            'KeyB', 'KeyA'
        ];
        let konamiPosition = 0;
        const animationDuration = 5000;

        function activateKonami() {
            const body = document.body;
            const header = document.querySelector('.header');

            body.classList.add('konami-active');
            header.classList.add('konami-active');

            document.querySelectorAll('.post').forEach(post => {
                post.classList.add('konami-animation');
            });

            setTimeout(() => {
                body.classList.remove('konami-active');
                header.classList.remove('konami-active');
                
                document.querySelectorAll('.post').forEach(post => {
                    post.classList.remove('konami-animation');
                });
            }, animationDuration);

            alert("¬°C√ìDIGO KONAMI ACTIVADO!");
        }

        document.addEventListener('keydown', (e) => {
            if (e.target.matches('input') || e.target.matches('textarea')) {
                return;
            }

            const requiredKey = konamiCode[konamiPosition];
            const pressedCode = e.code; 

            if (pressedCode === requiredKey) {
                konamiPosition++;

                if (konamiPosition === konamiCode.length) {
                    activateKonami();
                    konamiPosition = 0;
                }
            } else if (konamiCode.includes(pressedCode)) {
                konamiPosition = 0;
            }
        });
        
        // -------------------------------------------------------------
        // ** INICIALIZACI√ìN **
        // -------------------------------------------------------------
        renderThemeList();

    </script>

</body>
</html>